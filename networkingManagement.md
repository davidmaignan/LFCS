# Networking

## ip vs ifconfig

```bash
ipconfig <interface>

ip a         #addr
ip link
ip n         #neibourghs
```

## Virtual interfaces
```
ip netns add development
ip netns
```

## Hostname

```bash
hostname
uname -n

hostnamectl set-hostname <newhostname>  #set all names (transiant, persistent, pretty)
hostnamectl <new_host_name>             #transient-name
cat /etc/hostname                       #persitent-name
cat /etc/machine-info                   #pretty-name
```

```bash
hostnamectl

>Static hostname: toquartAsus
>Icon name: computer-laptop
>Chassis: laptop
>Machine ID: 530ae95433434be18945cfa32a166a27
>Boot ID: f6581969f1f947d3b1b2c2232ebdee34
>Operating System: Fedora 31 (Workstation Edition)
>CPE OS Name: cpe:/o:fedoraproject:fedora:31
>Kernel: Linux 5.5.11-200.fc31.x86_64
>Architecture: x86-64
```

```bash
#/etc/hosts
#IP          FQDN                           ALIAS   ALIAS
192.168.56.1 my_server_hostname.domain.com  alias1  alias2

ping alias1

```

## DNS

Check for hostname resolution order is controleld by nsswitch.conf

### Multicast DNS

```bash
yum info avahi #rendezvous bonjour for mac/windows

getent hosts

grep hosts /etc/nsswitch.conf

cat /etc/resolv.conf #DNS server address - generated by NetworkManager service

```

### dig

```bash
yum install -y bind-utils

dig www.pluralsight.com
> ...
> ;; Query time: 85 msec
> ;; SERVER: 192.168.2.1#53(192.168.2.1) #DNS server address
> ;; WHEN: Sat Mar 28 00:25:55 EDT 2020
> ;; MSG SIZE  rcvd: 132

dig www.pluralsight.com @8.8.8. #with a specific remote dns server !!

dig +short www.pluralsight.com  #short version
dig +short pluralsight.com MX   #mail server
```

## Synchronisation - NTP network time protocol

Setting a time server and synchronize client with accurate time. Reduce http request outside.

Hardware vs system time : hwclock command

Hardware clock (motherboard) shutdown script write systemclock to hwclock so when starts up get right time

```bash
date            #gives system clock
hwclock         #gives hardware clock

date --set="20160406 12:03" #change system time
hwclock --hctosys           #set system clock from hardware clock
hwclock --systohc           #set hardware clock from system clock


timedatectl
>      Local time: Sat 2020-03-28 00:50:00 EDT       # system time
>  Universal time: Sat 2020-03-28 04:50:00 UTC
>        RTC time: Sat 2020-03-28 04:50:00           # hardware time
>       Time zone: America/New_York (EDT, -0400)
>     NTP enabled: yes
>NTP synchronized: no
> RTC in local TZ: no
>      DST active: yes
> Last DST change: DST began at
>                  Sun 2020-03-08 01:59:59 EST
>                  Sun 2020-03-08 03:00:00 EDT
> Next DST change: DST ends (the clock jumps one hour backwards) at
>                  Sun 2020-11-01 01:59:59 EDT
>                  Sun 2020-11-01 01:00:00 EST

timedatectl set-ntp false       #synchronize with time server

```

```bash
yum install -y chrony

#/etc/chrony.conf
systemct start|stop|enabled|disable|restart chronyd.service
chronyc tracking
chronyc sources

yum install -y ntp
#/etc/ntp.conf
systemctl start ntpd
ntpq -p                 #query ntp service
```

## Network services

configure networking and hostname resolution statically or dynamically
configure network services at boot

inet6 fe80:... (local network for ipv6)

```bash
ip addr show
ip -4 -c a s enp0s8

ip addr add 172.17.67.3/16 dev enp0s8 #add to the tcp stack only

#Network manager - default service manager network connectivity
systemctl status NetworkManager
systemctl restart network

nmcli connection show|add

nmcli -p connection show <interface>

#Add a new connection for an interface
nmcli connection add con-name home ifname enp0s3 type ethernet ip4 192.168.0.99 gw4 192.168.0.1
nmcli conn up home
ip -c a s       #-c color a (addr) s (show)
```

```bash
systemctl status network

#/etc/sysconfig/network-scripts

NM_CONTROLLED=no    #NM = network manager


```

## Routing

statically route IP / Dynamically route IP

```bash
ip route show       #ip r
route
netstat -n

#Add a default route to a server configured as a router
ip route add default via <ip>


#Generated by NetworkManager.service
cat /etc/resolv.conf

#Add /etc/sysconfig/netword-scripts/ifcfg-<interface>
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO="no"
DEFROUTE=yes
DNS1="8.8.8.8"
DNS2="8.8.4.4"
GATEWAY="192.168.56.3"
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=enp0s8
UUID=07c77e1b-0330-4fb9-91eb-6dad64efce39
DEVICE=enp0s8
ONBOOT=yes
NM_CONTROLLED=no

#/proc/sys/net/ipv4/if_forward
0   #routing is turned off

#
vim /etc/sysctl.conf
# net.ipv4.ip_forward=1     #add line

sysctl -p  #reload
```

### Firewalling with Firewalld

```bash
systemctl status firewalld
iptables -L
iptables -t nat -L

# masquerading the ip address of the NAT router
iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE #add entry to nat table outbound traffic <network_interface> jump masquerade
```

```bash
firewall-cmd --state
systemctl start firewalld

#Zone: set up different rules for diffrent interfaces
firewall-cmd --get-default-zone
firewall-cmd --get-active-zones
firewall-cmd --get-zones

firewall-cmd --permanent --zone=public --remove-interface=enp0s3
firewall-cmd --permanent --zone=external --add-interface=enp0s3
systemctl restart firewalld.service

firewall-cmd --set-default-zone=external


firewall-cmd --list-all

firewall-cmd --permanent [--zone=<zone_id>] --remove--service=ssh
firewall-cmd --reload
firewall-cmd ---list- [--zone=<zone_id>]

firewall-cmd --permanent --zone=internal --add-service=nfs
firewall-cmd --permanent --zone=internal --add-service=glusterfs

firewall-cmd --list-services --zone=internal

#/usr/lib/firewalld/services   (location firewalld services config )

firewall-cmd --permanent --new-service="puppet"
# check /etc/firewalld/services/puppet.xml
restorcon /etc/firewalld/services/puppet.xml
chmod 640 puppet.xml
#add some configuration to xml file


firewall-cmd --permanent --remove-masquerade
```

### iptable toolset

https://www.howtogeek.com/177621/the-beginners-guide-to-iptables-the-linux-firewall/ 

```bash
iptables -
iptables-save > dest_file
iptables-restore < dest_file>

iptables -A INPUT -i lo -j ACCEPT               #Append: accept any input traffic on local interface
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT #if we accept connection, traffic can come back !
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT  #Insert INPUT section position 1 -protocole tcp ...

#vi dest_file
-A INPUT -j DROP        #rule means if no match drop the packet



yum install -y iptables-services

#/etc/sysconfig/iptables
systemctl start|enable|stop|disable iptables.service
```

## Tunneling

```bash
ssh -f -L 8080:localhost:80 root@server2 -N  #create tunnel to server2 
ps -ef| grep ssh


yum install -y openvpn easy-rsa
iptables -t -nat -A POSTROUTING -o enp0s3 - MASQUERADE

```

### Monitoring

```bash
tracepath www.pluralsight.com

ip link                         #see mac address
ip -s link show <interface>     #statistic on recieved and transmitted bytes

netstat -tln                    #tcp port listening list

netstat -i

sysstat 

yum install nmap

nmap scanme.nmap.org        #scan port open on a server
nmap --iflist
```
